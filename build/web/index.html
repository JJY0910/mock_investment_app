<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">

  <title>모의 투자 트레이더</title>
  <link rel="manifest" href="manifest.json">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png" />

  <!-- iOS 홈 화면 아이콘 -->
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Noto Sans KR', sans-serif;
    }

    #loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>

  <!-- TradingView Lightweight Charts -->
  <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
  <script>
    // Global chart registry
    window.tradingCharts = window.tradingCharts || {};

    // Create or recreate chart
    window.createChart = function (containerId, width, height) {
      console.log('[Chart] Creating chart:', containerId, width, height);

      // Clean up existing chart
      if (window.tradingCharts[containerId]) {
        window.tradingCharts[containerId].chart.remove();
        delete window.tradingCharts[containerId];
      }

      const container = document.getElementById(containerId);
      if (!container) {
        console.error('[Chart] Container not found:', containerId);
        return false;
      }

      try {
        const chart = LightweightCharts.createChart(container, {
          width: width,
          height: height,
          layout: {
            background: { color: '#ffffff' },
            textColor: '#333333',
          },
          grid: {
            vertLines: { color: '#f0f0f0' },
            horzLines: { color: '#f0f0f0' },
          },
          timeScale: {
            borderColor: '#cccccc',
            timeVisible: true,
            secondsVisible: false,
          },
        });

        const candleSeries = chart.addCandlestickSeries({
          upColor: '#26a69a',
          downColor: '#ef5350',
          borderVisible: false,
          wickUpColor: '#26a69a',
          wickDownColor: '#ef5350',
        });

        window.tradingCharts[containerId] = { chart, candleSeries };
        console.log('[Chart] Created successfully');
        return true;
      } catch (e) {
        console.error('[Chart] Error creating chart:', e);
        return false;
      }
    };

    // Set full chart data
    window.setChartData = function (containerId, data) {
      const chartObj = window.tradingCharts[containerId];
      if (!chartObj) {
        console.error('[Chart] Chart not found:', containerId);
        return false;
      }
      try {
        chartObj.candleSeries.setData(data);
        return true;
      } catch (e) {
        console.error('[Chart] Error setting data:', e);
        return false;
      }
    };

    // Update last candle
    window.updateCandle = function (containerId, candle) {
      const chartObj = window.tradingCharts[containerId];
      if (!chartObj) return false;
      try {
        chartObj.candleSeries.update(candle);
        return true;
      } catch (e) {
        console.error('[Chart] Error updating candle:', e);
        return false;
      }
    };

    // Resize chart
    window.resizeChart = function (containerId, width, height) {
      const chartObj = window.tradingCharts[containerId];
      if (!chartObj) return false;
      try {
        chartObj.chart.resize(width, height);
        return true;
      } catch (e) {
        console.error('[Chart] Error resizing:', e);
        return false;
      }
    };

    console.log('[Chart] Chart management functions loaded');
  </script>
</head>

<body>
  <!-- 로딩 스피너 -->
  <div id="loading">
    <div class="spinner"></div>
  </div>

  <script src="main.dart.js" type="application/javascript"></script>
</body>

</html>